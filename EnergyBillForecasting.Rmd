---
title: "EnergyForecasting"
author: "P Rode"
date: "1/3/2021"
output: html_document
---

```{r setup, echo="FALSE", results='hide', include=FALSE }

###############################################################################
#                             Set up envirment                                #
###############################################################################


  # Enviroment 
  # Loading and preprocessing the data
  #Set up enviroment for R scrip  
  # Packages for tidyverse 
    library("tidyverse")
    library("gridExtra")
    library("lubridate")
  # Package for building tables in markdown and notebook 
    library("knitr")
    library("kableExtra") 
    library("xtable")
  # Packages for forecasting
    library("fable")
  library("tsibble")
  library("feasts")
  library("tsibbledata")
  # Packages for reading excel and html files and XML
    library("openxlsx")
    library("XML")
  # Parkage for using data tables for very large data operations
    library("data.table")
    library("tidyfast")
    library("dtplyr")
  #Package for reading fixed width tables
    library("utils")
  # Packages for reading data through API's 
    library("httr")
    library("jsonlite")
  # Package for performing inquires with SQL databases 
    library("sqldf")
  #Package for reading and writing to jpeg files
    library("jpeg")

  # Set proper working Dir 
    if (!getwd() == "C:/Users/paulr/Documents/R/EnergyForecasting") {setwd("C:/Users/paulr/Documents/R/EnergyForecasting")}

# Check for data directory and if one is not present then make it
if (!file.exists("data")) {
  dir.create("data")
}
```



```{r, echo="FALSE", results='hide', include=FALSE }

###############################################################################
#                     Read data in and get date formats right                 #
###############################################################################


setAs("character","myDate", function(from) {mdy_hm(from)})

Electric_Data <- fread("C:/Users/paulr/Documents/R/EnergyForecasting/data/MACH Energy - Data (4).csv", colClasses = c(Date = "myDate", Value = "integer", Unit = "character"), stringsAsFactors = TRUE)

Steam_Data <- fread("C:/Users/paulr/Documents/R/EnergyForecasting/data/MACH Energy - Data (3).csv", colClasses = c("myDate", "integer", "Character"), stringsAsFactors = TRUE)


```


```{r, echo="FALSE", results='hide', include=FALSE }

###############################################################################
#                               Do Simple Plots                               #
###############################################################################

Steam_Data <- fread("C:/Users/paulr/Documents/R/EnergyForecasting/data/MACH Energy - Data (3).csv", colClasses = c("myDate", "integer", "Character"), stringsAsFactors = TRUE)
Steam_Data[, Value := as.integer(Value)]
Steam_Data[, ymdDate := date(Date)]
Steam_Data[, .(Value = sum(Value)), by = ymdDate] -> Steam1 #Summarise kWh per day. 
Steam_Data[, .(Value = mean(Value)), by = month(ymdDate)] -> Steam2 #Summarise kWh per day. 

png(filename="bench_query_sort.png", width=1200, height=300)
ggplot(data=Steam1, aes(x=ymdDate, y=Value)) + 
  geom_col(size=0.001) + 
  labs(x = "Date", y = "mlb") + 
  scale_fill_continuous(guide = guide_legend(title = NULL)) +
  theme_bw() 

ggplot(data=Steam2, aes(x=month, y=Value)) + 
  geom_col(size=0.001) + 
  labs(x = "Month", y = "mlb") + 
  scale_fill_continuous(guide = guide_legend(title = NULL)) +
  theme_bw() 

```

#Read in data and fix formats

alldata <- read_csv("./data/MASTER METERING DATA(2).csv", col_names = TRUE, col_types = "cccccddcd")
alldata$`Start Date`<- mdy(alldata$`Start Date`)
alldata$`End Date` <- mdy(alldata$`End Date`)
alldata %>% mutate(Month = month(`Start Date`), Period = (alldata$`End Date`- alldata$`Start Date`))  -> alldata

# Summeraze data by building and utility to make a lookup table
alldata %>% group_by(Building, `Meter Type`, `Start Date`, `End Date`) %>% summarise(Usage = sum(Usage)) %>% mutate(Usage_Day = Usage / as.numeric(`End Date` - `Start Date`)) -> alldata

#Set up main utility data collection table 
UtilityData <- data.frame(building = "builidng", datekey = "January 2017", kWh = 1, date = ymd("2017-01-05"), HDD = 1, CDD = 1, varriable = 1 )
UtilityData[-1,] -> UtilityData

# Bring in DD and then join days per month to get a dataframe with DD/day to then combine with the main alldata
hdd <- read_csv("./data/NYSERDA HDD.csv")
colnames(hdd)[1] <- "Month"
hdd %>% select(1:5) %>% gather(key = "key", value = "HDD", -1) %>%
  mutate(datekey = paste(Month,key)) %>% select(datekey, HDD, -Month,-key) -> hdd
hdd[is.na(hdd)] = 0 # get rid of NA's

cdd <- read_csv("./data/NYSERDA CDD.csv")
colnames(cdd)[1] <- "Month"
cdd %>% select(1:5) %>% gather(key = "key", value = "CDD", -1) %>%
   mutate(datekey = paste(Month,key)) %>% select(datekey, CDD, -Month,-key) -> cdd
cdd[is.na(cdd)] = 0 # get rid of NA's


```
